var jwt = require('jsonwebtoken');
var expressJwt = require('express-jwt');
var params = require('express-params');
var passport = require('passport');

require('./setup-passport-serenity');

module.exports = function(app) {
	
	params.extend(app);

	//common routes
	app.get('/_auth_/callback', function(req, res, next) {
	  passport.authenticate('auth0', function(err, user, info) {
	    if (err) return next(err);
	    if (!user) {
	    	return res.redirect('/login');
	    } else {
	      return res.redirect('/#/_auth_/login?jwt=' + info.id_token + '&state=' + req.query.state);	    	
	    }
	  })(req, res, next);
	});	

	app.get('/_auth_/handleAuthError', function(req, res) {
		console.log('have auth error');
	})
	
	// temporal fix
	var auth0Client = process.env.TC_AUTH0_CLIENT || 'foo';
	var auth0Secret = process.env.TC_AUTH0_SECRET || 'bar'; 
	var jwtCheck = expressJwt({
		secret: new Buffer(auth0Secret, 'base64')
	});
	
	return jwtCheck;
}